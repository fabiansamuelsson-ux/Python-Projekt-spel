import time
import random
from pyfiglet import Figlet
f = Figlet(font="doom")

print(f.renderText("DDD(Dungeon Destroyer Dome)"))

#Spel
def print_slowly(text, delay=0.05):
    for char in text:
        print(char, end='', flush=True)
        time.sleep(delay)
    print()


class fiende:
   def __init__(self, name, level_range, str_range, damage_range, hp=None):
      self.name = name
      self.level_range = level_range
      self.str_range = str_range
      self.damage_range = tuple(damage_range)
      self.LVL = random.randint(level_range[0], level_range[1])
      self.STR = random.randint(str_range[0], str_range[1])
      self.damage = random.randint(self.damage_range[0], self.damage_range[1])
      self.max_HP = hp if hp is not None else 10 + (self.LVL - 1) * 2 + max(0, self.STR - 4)
      self.HP = self.max_HP
   
   def attack_damage(self):
      return random.randint(self.damage_range[0], self.damage_range[1])
   
def spawn_enemy_for_level(LVL):
    if 1 <= LVL <= 3:
        return fiende("Larry", (1, 3), (4, 6), (1, 2), hp=10)
    elif 4 <= player.LVL <= 6:
        return fiende("Zombie", (4, 7), (7, 9), (2, 4), hp=20)
    elif 7 <= player.LVL <= 9:
        return fiende("Wolves", (8, 10), (10, 14), (4, 6), hp=30)
    else:
        enemy_type = random.randrange([
            ("Larry", (1, 3), (4, 6), (1, 2), 10),
            ("Zombie", (4, 6), (7, 9), (2, 4), 20),
            ("Wolves", (7, 9), (10, 14), (4, 6), 30)
        ])
        return fiende(enemy_type[0], enemy_type[1], enemy_type[2], enemy_type[3], hp=enemy_type[4])
    
class adventurer:
   max_LVL = 10

   class Inventory:
      def __init__(self):
         self.items = []
      def add_item(self, item):

         self.items.append(item)
         print_slowly(f"{item} has been added to your inventory")

      def drop_item(self, item):
         if item in self.items:
            self.items.remove(item)
            print_slowly(f"{item} has been dropped")
         else:
            print_slowly(f"{item} is not in inventory")

      def show_Inventory(self):
         if not self.items:
            print_slowly("inventory is empty")
         else:
            print_slowly("Your inventory contains:")
            for i, item in enumerate(self.items, 1):
               print_slowly(f"{i}. {item}")

   def __init__(self, name, HP=20, STR=5, LVL=1):
      self.name = name
      self.HP = HP
      self.STR = STR
      self.LVL = LVL
      self.game_over = False
      self.inventory = self.Inventory()

   def level_up(self):
      if self.game_over:
         print_slowly("GAME OVER"
         "You have failed in clearing the dungeon, the monsters within have multiplied and escaped. The world has been run over and destroyed.")
         return

      if self.LVL < self.max_LVL:
         self.LVL += 1
         self.HP += 2
         self.STR += 1
         print_slowly(f"{self.name} leveled up to {self.LVL}!")
         print_slowly(f"HP is now {self.HP}, STR is now {self.STR}.")

         if self.LVL == self.max_LVL:
            print_slowly(f"Congratulations adventurer {self.name}, you have reached level {self.LVL}!")
            self.game_over = True

   def status(self):
        return f"{self.name} - LVL {self.LVL} HP {self.HP} STR {self.STR}"

def Open(adventurer):
   facing = random.randrange(3)
   if facing == 0:
       return Kista()
   elif facing == 1:
       return spawn_enemy_for_level(adventurer.LVL)
   else:
       return fälla()
   
class Kista:
    def __init__(self):
        self.möjliga_saker = [
            "Healing pot",
            "Strength pot",
            "Rotten apple",
            "Old Bok",
        ]

class fälla:
    def __init__(self, damage=None, type="spike"):
        if damage is None:
            damage = random.randint(1, 10)
        self.damage = damage
        self.type = type

    def trigger(self, adventurer):
        print_slowly(f"You triggered a {self.type} trap!")
        adventurer.HP -= self.damage
        print_slowly(f"You took {self.damage} damage! HP is now {adventurer.HP}.")
        
        if player.HP < 0:
            print_slowly(f"{adventurer.name} has been defeated by the trap...")
            player.game_over = True
            return False
        return True
    
class attack:
    def __init__(self, damage_range=(4, 6), type="slash"):
        if isinstance(damage_range, int):
            self.damage_range = (damage_range, damage_range)
        else:
            self.damage_range = tuple(damage_range)
        self.type = type

    def trigger(self, target):
        dmg = random.randint(self.damage_range[0], self.damage_range[1])

        if not hasattr(target, "HP"):
            print_slowly("The attack has no effect (target has no HP).")
            return None

        target.HP -= dmg
        target_name = getattr(target, "name", "the target")
        print_slowly(f"You {self.type} {target_name} for {dmg} damage!")

        if target.HP <= 0:
            print_slowly(f"{target_name} has been defeated!")
            return False

        print_slowly(f"{target_name} HP is now {target.HP}.")
        return True

name = "0"
while not name.isalpha():
   name = input("What is your name adventurer? (only characters, not numbers) -> ")
print_slowly(f"I am sorry {name}")
print_slowly("You have been chosen to clear out a dungeon for the guild ")
print_slowly("Best of luck to you, we hope you return...")
print_slowly(f"As you walk towards the dungeon, you spot 3 doors, {name} you have to take your pick")
player = adventurer(name)
print_slowly(player.status())

while player.LVL < player.max_LVL and not player.game_over:
    DoorNumber = None
    while DoorNumber not in ["1", "2", "3"]:
        DoorNumber = input("""Which door do you choose adventurer?, the dungeon is not clear yet
                           
[1] The door to the right
[2] The door in the middle
[3] The door to the left 
 -> """)
        
        if DoorNumber == "1":
            print_slowly("You choose the door to the right!")
            encounter = Open(player)
        elif DoorNumber == "2":
            print_slowly("You choose the door in the middle!")
            encounter = Open(player)
        elif DoorNumber == "3":
            print_slowly("You choose the door to the left!")
            encounter = Open(player)    
        else:
            print_slowly("Please enter a valid input fellow guild member") 
            continue

        if isinstance(encounter, Kista):
            print_slowly("You have found a chest!")
            loot = random.choice(encounter.möjliga_saker)
            print_slowly(f"Inside you find: {loot}")
            player.inventory.add_item(loot)
            player.level_up()

        elif isinstance(encounter, fälla):
            print_slowly("You keep walking and see nothing, OH NO!, you have stepped into a trap")
            encounter.trigger(player)

        elif isinstance(encounter, fiende):
            print_slowly("A foe has appeared, steady yourself")
            print_slowly(f"Enemy: {encounter.name}")
            if hasattr(encounter, "max_HP"):
                encounter.HP = encounter.max_HP
            try:
                print_slowly(f"{encounter.name} stats - HP {encounter.HP} STR {encounter.STR}")
            except Exception:
                pass

            while encounter.HP > 0 and player.HP > 0:
                action = input("""What do you want to do? ->
                    [A]ttack
                    [I]nventory
                    [S]tatus
                    """).lower()

                if action == "a":
                        atk = attack()
                        target_alive = atk.trigger(encounter)

                        if target_alive is False:
                            print_slowly("you level up")
                            player.level_up()
                            break

                        else:
                            base = encounter.attack_damage()

                            if getattr(encounter, "STR", 0) > getattr(player, "STR", 0):
                                actual = base * 2
                            else:
                                actual = base

                            player.HP -= actual
                            print_slowly(f"{encounter.name} hits you for {actual} damage. Your HP is now {player.HP}.")
                            if player.HP <= 0:
                                print_slowly(f"{player.name} has been defeated")
                                player.game_over = True
                                break

                elif action == "i":
                    player.inventory.show_Inventory()

                elif action == "s":
                    print_slowly(player.status())
            else:
                print_slowly("Unknown action. Try 'a', 'i' or 's'.")
